name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Optional Build workflow run ID to publish from when dispatching manually'
        required: false

jobs:
  release_on_thunderstore:
    if: |
      github.ref != 'refs/heads/codex' &&
      github.head_ref != 'codex' &&
      github.base_ref != 'codex'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      actions: read
    steps:
      - name: Ensure release is published
        if: github.event_name == 'release'
        run: |
          if [[ "${{ github.event.release.draft }}" == 'true' || "${{ github.event.release.prerelease }}" == 'true' ]]; then
            echo 'Release must be published and not marked as draft or prerelease.' >&2
            exit 1
          fi

      - name: Resolve Build workflow run
        id: resolve_run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_COMMITISH: ${{ github.event_name == 'release' && github.event.release.target_commitish || '' }}
          MANUAL_RUN_ID: ${{ github.event.inputs.run_id }}
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            if [[ -z "${TARGET_COMMITISH}" ]]; then
              echo "Release payload did not include target_commitish." >&2
              exit 1
            fi

            target_sha=$(gh api "repos/${GITHUB_REPOSITORY}/commits/${TARGET_COMMITISH}" --jq '.sha')

            if [[ -z "${target_sha}" || "${target_sha}" == "null" ]]; then
              echo "Unable to resolve commit SHA for ${TARGET_COMMITISH}." >&2
              exit 1
            fi

            run_id=$(gh api --paginate "repos/${GITHUB_REPOSITORY}/actions/workflows/build.yml/runs" -f per_page=100 \
              | jq -r --arg sha "${target_sha}" '
                .workflow_runs[]? | select(.head_sha == $sha and .conclusion == "success") | .id
              ' | head -n 1)

            if [[ -z "${run_id}" || "${run_id}" == "null" ]]; then
              echo "Unable to find a successful Build workflow run for commit ${target_sha}." >&2
              exit 1
            fi
          else
            run_id="${MANUAL_RUN_ID:-}"

            if [[ -z "${run_id}" ]]; then
              echo "Manual dispatch requires specifying a Build workflow run ID." >&2
              exit 1
            fi

            gh api "repos/${GITHUB_REPOSITORY}/actions/runs/${run_id}" --jq '.id' >/dev/null
          fi

          echo "run_id=${run_id}" >> "${GITHUB_OUTPUT}"

      - name: Download Thunderstore package artifact
        uses: actions/download-artifact@v3
        with:
          run-id: ${{ steps.resolve_run.outputs.run_id }}
          pattern: thunderstore-package-*
          path: build-artifacts
          merge-multiple: true

      - name: Extract package metadata
        id: package_metadata
        run: |
          set -euo pipefail

          artifact_root="build-artifacts"
          metadata_file=$(find "${artifact_root}" -type f -name 'build-metadata.json' | head -n 1)

          if [[ -z "${metadata_file}" ]]; then
            echo "Unable to locate build-metadata.json in downloaded artifacts." >&2
            exit 1
          fi

          version=$(jq -r '.version' "${metadata_file}")

          if [[ -z "${version}" || "${version}" == "null" ]]; then
            echo "build-metadata.json did not contain a valid version." >&2
            exit 1
          fi

          package_zip=$(find "${artifact_root}" -type f -name "Penumbra-v${version}.zip" | head -n 1)

          if [[ -z "${package_zip}" ]]; then
            package_zip=$(find "${artifact_root}" -type f -name '*.zip' | head -n 1)
          fi

          if [[ -z "${package_zip}" ]]; then
            echo "Unable to locate packaged Thunderstore zip from Build artifacts." >&2
            exit 1
          fi

          echo "version=${version}" >> "${GITHUB_OUTPUT}"
          echo "package_zip=${package_zip}" >> "${GITHUB_OUTPUT}"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            6.0.x

      - name: Install Thunderstore CLI (tcli)
        run: dotnet tool install --global tcli

      - name: Publish build to Thunderstore
        run: |
          tcli publish \
            --token "${{ secrets.THUNDERSTORE_KEY }}" \
            --package "${{ steps.package_metadata.outputs.package_zip }}" \
            --package-version "${{ steps.package_metadata.outputs.version }}"
